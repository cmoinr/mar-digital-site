name: Deploy to GitHub Pages (opcional)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build with GitHub Pages base URL
      run: npm run build
      env:
        VITE_BASE_URL: /mar-digital-site/

    - name: Deploy to gh-pages
      run: |
        # PASO 1: Guardar archivos compilados ANTES de cambiar rama
        mkdir -p /tmp/build-output
        cp -r dist/* /tmp/build-output/
        echo "✅ Archivos compilados guardados en /tmp/build-output"
        ls -la /tmp/build-output/
        
        # PASO 2: Configurar git
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # PASO 3: Cambiar a rama gh-pages
        git fetch origin gh-pages
        git checkout gh-pages
        echo "✅ Cambié a rama gh-pages"
        
        # PASO 4: Limpiar archivos viejos (excepto .git, .nojekyll, .gitignore)
        find . -maxdepth 1 -type f ! -name '.nojekyll' ! -name '.gitignore' ! -name '.git' -delete
        find . -maxdepth 1 -type d ! -name '.' ! -name '..' ! -name '.git' -exec rm -rf {} + 2>/dev/null || true
        echo "✅ Archivos viejos eliminados"
        
        # PASO 5: Copiar archivos compilados desde /tmp
        cp -r /tmp/build-output/* .
        echo "✅ Archivos compilados copiados desde /tmp"
        ls -la
        
        # PASO 6: Commit y push
        git add -A
        git commit -m "deploy: auto-build from main [skip ci]" || echo "No hay cambios para hacer commit"
        git push origin gh-pages
        echo "✅ Pushed a gh-pages"
        
        # PASO 7: Volver a main
        git checkout main
        echo "✅ Volvimos a main"
